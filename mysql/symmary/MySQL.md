# MySQLの学習
## 目次
- [MySQL]()
  - [概要]()
  - [データベース]()
  - [特徴]()
- [MySQLの使用]()
  - [インストール]()
  - [MySQL 起動・停止]()
  - [データベースの作成]()
  - [テーブルの作成]()
    - [unsigned]() 
    - [AUTO_INCREMENT]()
    - [PRIMARY KEY]()
    - [UNIQUE KEY]()
  - [データの編集(追加,削除,更新)]()
  - [データの閲覧]()
  - [INNODB]()
  - [utf8mb4]()
- [データ型のストレージ要件]()
  - [文字列型のストレージ要件]()
- [参考文献]()

## MySQL
### 概要
MySQLとは、世界でもっとも利用されている「データベース管理システム」のことです。
大容量のデータに対しても高速で動作し、便利な機能がたくさんあるので、非常に実用性が高くなっています。
また、オープンソースなので非商用利用であれば無償で使用できるため、初心者でも導入しやすく扱いやすいため非常に人気の高いデータベース管理システムです。

### データベース
データベースとは「複数で共有、利用すること」と「検索、加工すること」を目的に整理されたデータの集まりのことです。

### 特徴
MySQLは、小さいアプリケーションから巨大なアプリケーションまですべてに対応できるほどの拡張性をもっています。
また MySQLはさまざまな環境で動作するようにテストされているので、Linux、Mac、Windowsなどを問わず動作します。
さらに、オリジナルの機能を追加するなど、自由なカスタマイズも可能になってます。
MySQLには、独自の「ストレージエンジン」というものが採用されています。
ストレージエンジンとは、データベースを作成、更新、削除など基本的な操作を行うための中心の機能のことです。
MySQLは、ストレートエンジンをアプリケーションの用途に合わせて種類を選択することが可能なのです。

## MySQLの使用
### インストール
Homebrewという、Mac向けのパッケージ管理システムに下記コマンドでMySQLのインストールを行う。

```
$ brew update
$ brew install mysql
```
下記コマンドでインストールされているMySQLの基本情報(バージョン番号など)を確認することができます。

```
$ brew info mysql
```

### MySQL 起動・停止
MySQLを手動で起動/停止する方法です。下のコマンドで、MySQLの起動ができます。
```
$ mysql.server start
// 正常に起動できれば、下記のようにSUCCESSと表示されます。
Starting MySQL
 SUCCESS!
```

下のコマンドで、MySQLの停止ができます。
```
mysql.server stop
// 正常に停止できた場合も、下記のようにSUCCESSと表示されます。
Shutting down MySQL
.. SUCCESS!
```

### データベースの作成
下記のようなコマンドでデータベースを作成することができます。
`CREATE DATABASE データベース名;`
今回はuserというデータベースを作成しました。
```
mysql> CREATE DATABASE user;
Query OK, 1 row affected (0.00 sec)
```
`SHOW DATABASES;`というコマンドでデータベースの一覧を確認することができます。
先ほど作成したuserデータベースも無事に作成できていることが確認できます。
```
mysql> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| user               |
+--------------------+
5 rows in set (0.00 sec)
```
もしデータベースを間違えて作成してしまった場合やもう使わなくなった場合には、`DROP DATABASE データベース名;`コマンドで削除することができます。
```
mysql> DROP DATABASE データベース名;
```
ただDROPを使うと、そのデータベースに格納されている情報が全て削除されてしまいますので、使用する際は十分に注意しましょう。

データベースにテーブルなどを追加したい場合には、`USE データベース名;`コマンドで使用するデータベース名を指定してあげましょう。
```
mysql> USE user;
Database changed
```
正常に動けばデータベースが切り替わったことを教えてくれます。

### テーブルの作成
USE文でデータベースを指定したあと、`CREATE TABLE テーブル名 ( 列名 データ型 [オプション], 列名 データ型 [オプション], 列名 データ型 [オプション], … );
`でテーブルを作成することができます。
テーブルを作成する際は、テーブル名と一緒に上記のコマンドのように列名やデータ型、オプション（省略可）も併せて指定します。
オプションには、PRIMARY KEYやUNIQUEなどが指定できます。
#### unsigned
unsignedは、符号なし整数として保存することができる。

### AUTO_INCREMENT
AUTO_INCREMENTは、簡単にいうと自動的にシーケンス番号を割り当てることができる機能です。
実際に下記のように練習してみました。

```
// カラムはidとnameのみのテーブルを作成
mysql> CREATE TABLE user (
    ->   id INT NOT NULL AUTO_INCREMENT,
    ->   name CHAR(30) NOT NULL,
    ->   PRIMARY KEY (id)
    -> );
Query OK, 0 rows affected (0.08 sec)

// nameのみをテーブルにいれる
mysql> INSERT INTO user (name) VALUES
    ->   ('tanaka'),('satou'),('suzuki'),
    ->   ('nakajima'),('yamada'),('isida');
Query OK, 6 rows affected (0.00 sec)
Records: 6  Duplicates: 0  Warnings: 0

```

上記でnameカラムに対してのみ値をINSERTしたのにidも自動的に値が入っています。
これが`AUTO_INCREMENT`の機能です。
```
mysql> SELECT * FROM user;
+----+----------+
| id | name     |
+----+----------+
|  1 | tanaka   |
|  2 | satou    |
|  3 | suzuki   |
|  4 | nakajima |
|  5 | yamada   |
|  6 | isida    |
+----+----------+
6 rows in set (0.00 sec)
```
### PRIMARY KEY
テーブルには多くのデータが含まれており、 1 つ 1 つのデータには複数のカラムの値が格納されています。
格納されたすべてのデータの中から 1 つのデータを特定したいときに、1 つまたは複数のカラムの値を検索してデータを特定しますが、その時に最も適したカラムに設定されるのがプライマリーキーです。
カラムにプライマリーキー制約を設定すると、カラムには他のデータの値を重複することのない値しか格納することができなくなります。
またNULLも格納することができません。その結果、プライマリーキー制約が設定されたカラムの値を検索することで、テーブルの中でただ一つのデータを特定することができます。

```
mysql> show columns from user;
+------------+---------------------+------+-----+-------------------+-----------------------------+
| Field      | Type                | Null | Key | Default           | Extra                       |
+------------+---------------------+------+-----+-------------------+-----------------------------+
| id         | bigint(20) unsigned | NO   | PRI | NULL              | auto_increment              |
| name       | varchar(255)        | NO   |     | NULL              |                             |
| age        | bigint(3) unsigned  | NO   |     | NULL              |                             |
| gender     | bigint(3) unsigned  | NO   |     | NULL              |                             |
| updated_at | timestamp           | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
| created_at | timestamp           | NO   |     | CURRENT_TIMESTAMP |                             |
+------------+---------------------+------+-----+-------------------+-----------------------------+
6 rows in set (0.00 sec)
```

### UNIQUE KEY
PRIMARY KEYと同じように重複する値は保存できない。しかしnullは入れられる。
```
mysql> show columns from user_info;
+------------+---------------------+------+-----+-------------------+-----------------------------+
| Field      | Type                | Null | Key | Default           | Extra                       |
+------------+---------------------+------+-----+-------------------+-----------------------------+
| userId     | bigint(20) unsigned | NO   | PRI | NULL              |                             |
| email      | varchar(255)        | NO   | UNI | NULL              |                             |
| phone      | varchar(16)         | NO   |     | NULL              |                             |
| updated_at | timestamp           | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
| created_at | timestamp           | NO   |     | CURRENT_TIMESTAMP |                             |
+------------+---------------------+------+-----+-------------------+-----------------------------+
5 rows in set (0.00 sec)
```

### データの編集(追加,削除,更新)
データベースに作成したテーブルにデータをいれる方法は、下記の`INSERTコマンド`でいれることができます。
データを追加する列を指定したのち、VALUESでそれぞれの値を列挙していきます。
```
INSERT INTO テーブル名 (列名1, 列名2, 列名3, …) VALUES(値1, 値2, 値3, …);
```
作成したテーブルの値を変更したい時は、`UPDATEコマンド`を使用します。

```
UPDATE テーブル名 SET 列名1=更新値1 WHERE 列名1=値;
```
データベースと同じようにDROPでテーブルを削除できます。
データベースと同じで削除した際は、格納されている情報が全て削除されてしまいますので、使用する際は十分に注意しましょう。

```
mysql> DROP TABLE user;
Query OK, 0 rows affected (0.01 sec)
```

### データの閲覧
各テーブルに格納されているデータを閲覧する方法です。SELECT文を使うことで、テーブルに格納されているデータを見ることができます。
```
SELECT * FROM user;
```
上ではアスタリスク(*)を書いていますが、これは全てのデータを指定する場合に使います。
全ての列の、全てのデータが表示されます。
任意の列だけを見たい場合は、アスタリスクの部分を列名に変えればOKです。

### INNODB
MySQLの大きな特徴の一つとして，ストレージエンジンがあげられます。
ストレージエンジンとは，パーサによって最適化されたSQLクエリを実際に実行する機能部分です。
MySQLではさまざまなテーブル型に対するSQL操作を処理するコンポーネントとしてストレージエンジンを提供しています。
主に利用されていたストレージエンジンはInnoDBとMyISAMです。
InnoDBはMySQL5.5からデフォルトのストレージエンジンとなっており，MyISAMと違いトランザクションが利用できます。

- メリット
  - トランザクションが使えるので、リカバリが楽。
  - 行ロックを行うので更新/参照の競合が限定的になる。
- デメリット
  - 参照処理がMyISAMに比べて遅い。
  - データサイズがMyISAMに比べて大きくなるのでその分ディスク容量が必要。
 
下記のようにテーブルを作成するときに選択する。
```
mysql> CREATE TABLE テーブル名(列名 データ型) ENGINE = InnoDB;
```

### utf8mb4
調べてもよくわからなかったが、絵文字や中国語などを扱う際にutf8mb4だと何かと都合がいいようです。

- なぜutf8mb4を使うのか
  - utf8だと3バイトまでしか扱えず、絵文字や難しい漢字などを扱えなかった。
  - utf8mb4だと4バイトまで扱うことができるのでutf8で扱えなかった文字も扱える。
  - デメリットとして単純に容量が多くなる。utf8だと255文字×3バイト＝765バイト,utf8mb4だと255文字×4バイト＝1020バイトになる。
  - INDEXを貼るときにも注意が必要で767バイトという制限がありutf8だと引っかからないが、utf8mb4だと引っかかってしまう。
- ASCII(ASCIIコード(100文字弱の単純な1バイトコード)を使うようにして要領を抑える)をつける理由は、emailやphoneなどアルファベットや数字しか扱わない値に対して設定することでデータ容量を減らすことができる。

### [データ型のストレージ要件](https://dev.mysql.com/)
#### [文字列型のストレージ要件]()
長文などを保存する際にVARCHAR(255)やTEXTを設定しているのは、保存するデータが多くなるからなんとなくわかるが、名前などを保存する際もVARCHAR(255)に設定しているのはなぜだろうと疑問に思ったので、まとめる。
実際に文字列保存で使用する型一覧

<img width="1154" alt="スクリーンショット 2020-07-08 23 23 46" src="https://user-images.githubusercontent.com/57429437/86930507-14588700-c172-11ea-9521-6ed839e6a18d.png">

そもそもMySQLって指定した型のサイズを使用するのか？それとも実際に保存した値のサイズを使用するのか？
[公式ドキュメント](https://dev.mysql.com/)には下記のように記載があった。

>VARCHAR(255) カラムには最大 255 文字の長さの文字列を格納できます。そのカラムが latin1 文字セット (1 文字あたり 1 バイト) を使用すると仮定すると、実際に必要なストレージは文字列の長さ (L) に、文字列の長さを記録するための 1 バイトを加えた大きさとなります。文字列 'abcd' の場合、L は 4 で、ストレージ要件は 5 バイトになります。同じカラムが代わりにダブルバイト文字セット ucs2 を使用するように宣言されている場合、ストレージ要件は 10 バイトになります。'abcd' の長さは 8 バイトで、カラムの最大長が 255 よりも大きい (最大 510 バイト) ため、長さを格納するために 2 バイト必要になります。

上記を読むに結論、MySQLは指定した型のサイズではなく実際に保存したサイズプラス1バイトを加えた容量を使用する。
VARCHAR、VARBINARY、および BLOB と TEXT 型のような可変長型の型は、「カラム値の実際の長さ」と「カラムの可能な最大の長さ」と「カラムに使用される文字セット」によってストレージ要件が変わってくるようです。
なので、名前などの4文字から8文字程度を保存する想定のカラムに対してVARCHAR(255)やTEXT型を設定しても必要以上に容量を消費しパフォーマンスが悪くなることはないというわけです。

### では本当に少ない文字列のカラムでもサイズの大きい型を指定して実装することに問題は無いのでしょうか？
そもそもTEXT型とVARCHAR型の違いって何？
データベースエンジンから見た場合、VARCHAR型はDBストレージ内にデータそのものが格納されるが、TEXT型だとデータは外部に格納されてDBストレージにはそのポインタが格納されるみたいです。(InnoDBは違うらしいまだ調べきれていない）
(初めて知りました...外部に格納の外部ってどこー)

てことはデータのアクセス速度は、ポインタを追ってデータの実体にたどり着かなければならないTEXT型よりも、DBストレージに直接データが格納されているVARCHAR型のほうが早くなるみたいです。ただVARCHAR型のサイズはデータベースのストレージサイズの制限に影響されるので、大きいサイズのデータをVARCHAR型で格納することはあまりよろしくないみたい。

>大規模なデータベースを検索する場合、インデックスを作っておくと処理時間を短縮できます。しかし、文字列を含むインデックスを作る場合、varchar型は完全なインデックスが作れますが、text型を使っていると完全なインデックスが作れません。そのため、文字列を含むテーブルでインデックスを活用する場合は、varchar型を利用してください。

上記のようにインデックスを貼った場合の処理もTEXT型の場合、インデックスの文字数を指定しないと使えない制限付きでもあり、メンテナンス性とかを考えると...

### TEXT型はダメなのか？
>65536文字以上になる場合はVARCHARにできないので、MEDIUMTEXTしか選択肢がありません。
それ以下でも、MySQLのバージョンや設定によっては、TEXTの中身を除いて1行あたり65536バイトまでという制限があるので、VARCHARでは入らないことがあります。

小規模なシステムでは大した問題にはならないだろうけど、大規模なデータを取り扱うシステムではVARCHAR型とTEXT型の選び方が大事なんだろうなと感じた。自分がどうしてVARCHAR型あるいはTEXT型を選んだのか、きちんとした理解し理由を説明して実装できるようになります。

## 参考文献
[MySQL 公式](https://www.mysql.com/jp/)<br>
[MySQLの使い方](https://www.dbonline.jp/mysql/)<br>
[データ型](http://www.kusa.ac.jp/~kajiura/c/data/newpage1.htm)<br>
[AUTO_INCREMENT の使用](https://dev.mysql.com/doc/refman/5.6/ja/example-auto-increment.html)<br>
[デフォルトのMySQL ストレージエンジンとしてのInnoDB](https://dev.mysql.com/doc/refman/5.6/ja/innodb-default-se.html)<br>
[utf8mb4 文字セット (4 バイトの UTF-8 Unicode エンコーディング)](https://dev.mysql.com/doc/refman/5.6/ja/charset-unicode-utf8mb4.html)<br>
[MySQLのencodingをutf8からutfmb4に変更して寿司ビール問題に対応する](https://techracho.bpsinc.jp/hachi8833/2016_08_25/25044)<br>
[知っておきたい！ 文字コードの基礎知識 ……ASCII，シフトJIS，Unicode etc.](https://gihyo.jp/book/pickup/2019/0006)<br>
[MySQLでインデックスを貼る時に読みたいページまとめ(初心者向け)](https://qiita.com/C058/items/1c9c57f634ebf54d99bb)<br>
[MySQLで4バイトutf-8文字を扱う＆ファイルフォーマットを変更する](https://honey8823.hateblo.jp/entry/2018/05/02/174502)<br>
[PRIMARY KEY制約(主キー/プライマリキーを設定する)](https://www.dbonline.jp/mysql/table/index8.html)<br>
[MySQL](https://dev.mysql.com/)<br>
[MySQL：TEXTとVARCHARのパフォーマンス](https://nicj.net/mysql-text-vs-varchar-performance/)<br>
[MYSQL効率化](https://qiita.com/tenten1010/items/841b4cbe4fd5d74ce7ff)<br>
[MySQLテーブル設計のための、よく使うデータ型まとめ](https://proengineer.internous.co.jp/content/columnfeature/6728)<br>
